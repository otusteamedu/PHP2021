version: '3'

services:
  # PHP 1
  app1:
    build:
      context: ./deploy/fpm
      dockerfile: Dockerfile
    image: otus/php2021/app/php
    container_name: otus-php2021-app1
    volumes:
      - .:/var/www/application.local
    networks:
      - app-network

  # PHP 2
  app2:
    build:
      context: ./deploy/fpm
      dockerfile: Dockerfile
    image: otus/php2021/app/php
    container_name: otus-php2021-app2
    volumes:
      - .:/var/www/application.local
    networks:
      - app-network

  # Nginx 1
  webserver1:
    build:
      context: ./deploy/nginx
      dockerfile: Dockerfile
    image: otus/php2021/app/nginx
    container_name: otus-php2021-webserver1
    ports:
      - "8081:80"
    volumes:
      - .:/var/www/application.local
    networks:
      - app-network

  # Nginx 2
  webserver2:
    build:
      context: ./deploy/nginx
      dockerfile: Dockerfile
    image: otus/php2021/app/nginx
    container_name: otus-php2021-webserver2
    ports:
      - "8082:80"
    volumes:
      - .:/var/www/application.local
    networks:
      - app-network

  # Nginx Balancer
  balancer:
    build:
      context: ./deploy/nginx-balancer
      dockerfile: Dockerfile
    image: otus/php2021/app/balancer
    container_name: otus-php2021-balancer
    ports:
      - "80:80"
    volumes:
      - .:/var/www/application.local
    networks:
      - app-network

  # Memcached 1 w/ repcached
  memcached1:
    image: oktec/repcached:latest
    container_name: otus-php2021-memcached1
    restart: unless-stopped
    environment:
      SLAVE: memcached2
    ports:
      - "11221:11211"
    networks:
      - app-network

  # Memcached 2 w/ repcached
  memcached2:
    image: oktec/repcached:latest
    container_name: otus-php2021-memcached2
    restart: unless-stopped
    environment:
      SLAVE: memcached1
    ports:
      - "11222:11211"
    networks:
      - app-network

# Docker Networks
networks:
  app-network:
    driver: bridge
