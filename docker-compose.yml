version: "3"

services:
  balancer:
    build:
      context: docker/balancer
    ports:
      - "80:80"
    volumes:
      - ./:/var/www
    depends_on:
      - nginx_node_1
      - nginx_node_2
    networks:
      - otus-network

  nginx_node_1:
    build:
      context: docker/nginx
    volumes:
      - ./:/var/www
    depends_on:
      - php-fpm-1
      - php-fpm-2
    networks:
      - otus-network

  nginx_node_2:
    build:
      context: docker/nginx
    volumes:
      - ./:/var/www
    depends_on:
      - php-fpm-1
      - php-fpm-2
    networks:
      - otus-network

  php-fpm-1:
    build:
      args:
        USER_ID: 1000
        GROUP_ID: 1000
      context: docker/php-fpm
    volumes:
      - ./:/var/www
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - otus-network

  php-fpm-2:
    build:
      args:
        USER_ID: 1000
        GROUP_ID: 1000
      context: docker/php-fpm
    volumes:
      - ./:/var/www
    networks:
      - otus-network

  memcached:
    image: memcached:latest
    ports:
      - "11211:11211"
    networks:
      - otus-network


networks:
  otus-network:
    driver: bridge